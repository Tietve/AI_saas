#!/bin/bash

# Post-commit hook ƒë·ªÉ check v√† remind update memory files
# Install: Copy file n√†y v√†o .git/hooks/post-commit v√† chmod +x

echo ""
echo "üîç Checking if memory files need update..."

# Get list of changed files trong commit v·ª´a r·ªìi
CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD)

# Check if c√≥ structural changes
NEEDS_INDEX_UPDATE=false
NEEDS_CLAUDE_MD_UPDATE=false

# Check for new/modified controllers, services, routes
if echo "$CHANGED_FILES" | grep -qE "src/(controllers|services|routes)/.*\.(ts|js)$"; then
    echo "  üìÇ Detected changes in controllers/services/routes"
    NEEDS_INDEX_UPDATE=true
fi

# Check for new services/folders
if echo "$CHANGED_FILES" | grep -qE "backend/services/[^/]+/(src|prisma)"; then
    echo "  üì¶ Detected changes in services structure"
    NEEDS_INDEX_UPDATE=true
fi

# Check for config changes
if echo "$CHANGED_FILES" | grep -qE "\.(env|config|json)$"; then
    echo "  ‚öôÔ∏è  Detected config changes"
    NEEDS_CLAUDE_MD_UPDATE=true
fi

# Check for package.json changes (new dependencies/commands)
if echo "$CHANGED_FILES" | grep -q "package.json"; then
    echo "  üì¶ Detected package.json changes"
    NEEDS_CLAUDE_MD_UPDATE=true
fi

echo ""

# Show recommendations
if [ "$NEEDS_INDEX_UPDATE" = true ]; then
    echo "üí° RECOMMENDATION: Regenerate CODEBASE_INDEX.md"
    echo "   Run: node .claude/regenerate-index.js"
    echo ""
fi

if [ "$NEEDS_CLAUDE_MD_UPDATE" = true ]; then
    echo "üí° RECOMMENDATION: Update CLAUDE.md"
    echo "   Run: /memory (trong Claude Code)"
    echo "   Or: code CLAUDE.md"
    echo ""
fi

if [ "$NEEDS_INDEX_UPDATE" = false ] && [ "$NEEDS_CLAUDE_MD_UPDATE" = false ]; then
    echo "‚úÖ No memory updates needed for this commit"
    echo ""
fi

# Optional: Auto-regenerate index (uncomment n·∫øu mu·ªën t·ª± ƒë·ªông)
# if [ "$NEEDS_INDEX_UPDATE" = true ]; then
#     echo "üîÑ Auto-regenerating index..."
#     node .claude/regenerate-index.js
#     git add .claude/CODEBASE_INDEX.md
#     git commit --amend --no-edit
# fi
