name: E2E Tests

on:
  schedule:
    - cron: '0 2 * * *'  # Run nightly at 2 AM UTC
  workflow_dispatch:  # Manual trigger
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - '.github/workflows/e2e.yml'

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install backend dependencies
        run: |
          cd backend/shared && npm ci && npm run build
          cd ../services/auth-service && npm ci && npx prisma generate
          cd ../chat-service && npm ci && npx prisma generate
          cd ../billing-service && npm ci
          cd ../analytics-service && npm ci
          cd ../../api-gateway && npm ci

      - name: Setup databases
        run: |
          cd backend/services/auth-service
          npx prisma migrate deploy || npx prisma db push --skip-generate
          cd ../chat-service
          npx prisma migrate deploy || npx prisma db push --skip-generate
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db

      - name: Start backend services
        run: |
          cd backend/services/auth-service && npm start &
          cd backend/services/chat-service && npm start &
          cd backend/services/billing-service && npm start &
          cd backend/api-gateway && npm start &
          sleep 15
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379
          JWT_SECRET: test-jwt-secret-for-e2e
          JWT_REFRESH_SECRET: test-jwt-refresh-secret-for-e2e
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY || 'sk-mock-key' }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY || 'sk_test_mock' }}
          NODE_ENV: test

      - name: Verify services are running
        run: |
          curl -f http://localhost:3001/health || echo "Auth service not ready"
          curl -f http://localhost:3003/health || echo "Chat service not ready"
          curl -f http://localhost:3004/health || echo "Billing service not ready"
          curl -f http://localhost:4000/health || echo "Gateway not ready"

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Build frontend
        working-directory: frontend
        run: npm run build
        env:
          VITE_API_URL: http://localhost:4000
          VITE_WS_URL: ws://localhost:3003

      - name: Start frontend server
        working-directory: frontend
        run: |
          npm run preview -- --port 5173 &
          sleep 5

      - name: Run Playwright E2E tests
        working-directory: frontend
        run: npx playwright test
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:5173

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 30

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: frontend/test-results/
          retention-days: 30

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-screenshots
          path: frontend/test-results/**/screenshots/
          retention-days: 7

      - name: E2E summary
        if: always()
        run: |
          echo "## ðŸŽ­ E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Authentication | Check artifacts |" >> $GITHUB_STEP_SUMMARY
          echo "| Chat Features | Check artifacts |" >> $GITHUB_STEP_SUMMARY
          echo "| Billing | Check artifacts |" >> $GITHUB_STEP_SUMMARY
          echo "| UI Components | Check artifacts |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¸ Screenshots and videos available in artifacts" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Full Playwright report available for download" >> $GITHUB_STEP_SUMMARY

  visual-regression:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Build frontend
        working-directory: frontend
        run: npm run build
        env:
          VITE_API_URL: http://localhost:4000
          VITE_WS_URL: ws://localhost:3003

      - name: Start frontend preview
        working-directory: frontend
        run: |
          npm run preview -- --port 5173 &
          sleep 5

      - name: Run visual regression tests
        working-directory: frontend
        run: npx playwright test --grep @visual
        continue-on-error: true

      - name: Upload visual diff
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: visual-regression-diffs
          path: frontend/test-results/**/diff/
          retention-days: 14

  performance:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Analyze bundle size
        working-directory: frontend
        run: |
          npm run build -- --analyze || true
          du -sh dist/

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v9
        with:
          urls: |
            http://localhost:5173
            http://localhost:5173/login
            http://localhost:5173/chat
          uploadArtifacts: true
          temporaryPublicStorage: true

      - name: Performance summary
        if: always()
        run: |
          echo "## âš¡ Performance Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Lighthouse scores available in artifacts" >> $GITHUB_STEP_SUMMARY
