generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [vector]
}

/// Chat conversation between users and AI
model Conversation {
  /// Unique conversation identifier
  id          String    @id @default(cuid())
  /// User who owns this conversation
  userId      String
  /// Conversation title for display
  title       String    @default("New Chat") @db.VarChar(255)
  /// AI model used (gpt-4, gpt-3.5-turbo, claude-3, etc.)
  model       String    @default("gpt-4") @db.VarChar(50)
  /// Whether conversation is pinned to top
  pinned      Boolean   @default(false)
  /// Conversation status
  status      String    @default("active") // active|archived|deleted
  /// AI temperature setting (0.0-2.0)
  temperature Float?
  /// Soft delete timestamp
  deletedAt   DateTime?
  /// User who deleted the conversation
  deletedBy   String?
  /// Created timestamp
  createdAt   DateTime  @default(now())
  /// Last updated timestamp
  updatedAt   DateTime  @updatedAt

  messages  Message[]

  @@index([userId, updatedAt(sort: Desc)])
  @@index([userId, pinned])
  @@index([userId, status])
  @@index([deletedAt])
}

/// Individual message in a conversation
model Message {
  /// Unique message identifier
  id             String       @id @default(cuid())
  /// Parent conversation ID
  conversationId String
  /// Message role (user, assistant, system)
  role           String       @db.VarChar(20)
  /// Message content
  content        String       @db.Text
  /// Content type (text, image, file, system)
  contentType    String       @default("text") @db.VarChar(20)
  /// Token count for this message
  tokenCount     Int          @default(0)
  /// AI model used for this message
  model          String?      @db.VarChar(50)
  /// Soft delete timestamp
  deletedAt      DateTime?
  /// User who deleted the message
  deletedBy      String?
  /// Created timestamp
  createdAt      DateTime     @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt(sort: Asc)])
  @@index([conversationId, role])
  @@index([conversationId, contentType])
  @@index([deletedAt])
}

/// Token usage tracking for billing and quotas
model TokenUsage {
  /// Unique usage record identifier
  id               String   @id @default(cuid())
  /// User who incurred the usage
  userId           String
  /// Conversation where tokens were used
  conversationId   String?
  /// Specific message that used tokens
  messageId        String?
  /// AI model used
  model            String   @db.VarChar(50)
  /// Input/prompt tokens
  promptTokens     Int
  /// Output/completion tokens
  completionTokens Int
  /// Total tokens (prompt + completion)
  totalTokens      Int
  /// Cost in USD
  cost             Float
  /// Created timestamp
  createdAt        DateTime @default(now())

  @@index([userId, createdAt(sort: Desc)])
  @@index([conversationId])
  @@index([conversationId, createdAt])
  @@index([messageId])
}

/// PDF Document uploaded by users
model Document {
  /// Unique document identifier
  id             String          @id @default(cuid())
  /// User who uploaded the document
  userId         String
  /// Document title (from filename or user-provided)
  title          String          @db.VarChar(255)
  /// Original filename
  fileName       String          @db.VarChar(255)
  /// MIME type (application/pdf)
  contentType    String          @default("application/pdf")
  /// File size in bytes
  fileSize       Int
  /// Number of pages in PDF
  pageCount      Int?
  /// R2 storage key (path in bucket)
  storageKey     String
  /// Processing status
  status         DocumentStatus  @default(PROCESSING)
  /// Error message if processing failed
  errorMessage   String?         @db.Text
  /// Associated document chunks
  chunks         DocumentChunk[]
  /// Upload timestamp
  uploadedAt     DateTime        @default(now())
  /// Processing completion timestamp
  processedAt    DateTime?
  /// Soft delete timestamp
  deletedAt      DateTime?

  @@index([userId, uploadedAt])
  @@index([status])
  @@map("documents")
}

/// Text chunks extracted from PDF with embeddings
model DocumentChunk {
  /// Unique chunk identifier
  id             String    @id @default(cuid())
  /// Parent document ID
  documentId     String
  /// Parent document relation
  document       Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  /// Extracted text content
  content        String    @db.Text
  /// Chunk index (0-based ordering)
  chunkIndex     Int
  /// Source page number in PDF
  pageNumber     Int?
  /// Token count for this chunk
  tokens         Int
  /// Vector embedding (1536 dimensions for OpenAI text-embedding-3-small)
  embedding      Unsupported("vector(1536)")?
  /// Created timestamp
  createdAt      DateTime  @default(now())

  @@index([documentId, chunkIndex])
  @@map("document_chunks")
}

/// Document processing status enum
enum DocumentStatus {
  PROCESSING
  COMPLETED
  FAILED
}
