openapi: 3.0.0
info:
  title: AI SaaS Chat Platform API
  version: 1.0.0
  description: |
    Complete REST API documentation for AI-powered chat platform with support for multiple AI providers.

    **Base URL**: `/api`

    **Authentication**: JWT Bearer Token required for most endpoints

    **Rate Limiting**: All endpoints implement intelligent rate limiting
  contact:
    name: API Support
    email: api@yourdomain.com
  license:
    name: Proprietary
    url: https://yourdomain.com/license

servers:
  - url: https://api.yourdomain.com
    description: Production
  - url: https://staging-api.yourdomain.com
    description: Staging
  - url: http://localhost:4000
    description: Local development

paths:
  # =====================================================
  # AUTHENTICATION ENDPOINTS
  # =====================================================
  /auth/signup:
    post:
      summary: Register new user account
      description: Create a new user account with email and password verification
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                password:
                  type: string
                  minLength: 8
                  example: SecurePass123!
                  description: Password must contain uppercase, lowercase, numbers and special characters
      responses:
        '200':
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: User created successfully
                  user:
                    $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/ValidationError'
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Too many signup attempts (5 per hour)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/signin:
    post:
      summary: Authenticate user and create session
      description: Login with email and password to receive session token
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
      responses:
        '200':
          description: Login successful
          headers:
            Set-Cookie:
              schema:
                type: string
                example: sessionId=abc123; Path=/; HttpOnly
              description: Session cookie
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Login successful
                  user:
                    $ref: '#/components/schemas/User'
        '400':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Too many login attempts (10 per 15 minutes)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/signout:
    post:
      summary: Sign out user
      description: Clear user session and invalidate token
      tags: [Authentication]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Signed out successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Signed out successfully

  /auth/me:
    get:
      summary: Get current user info
      description: Retrieve authenticated user's profile information
      tags: [Authentication]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User profile retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /auth/verify-email:
    post:
      summary: Verify email address
      description: Confirm email ownership with verification token
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, token]
              properties:
                email:
                  type: string
                  format: email
                token:
                  type: string
                  description: Verification token from email
      responses:
        '200':
          description: Email verified successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Email verified successfully
        '400':
          description: Invalid or expired token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/forgot-password:
    post:
      summary: Request password reset
      description: Send password reset link to user's email
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email:
                  type: string
                  format: email
      responses:
        '200':
          description: Reset email sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password reset email sent
        '429':
          description: Too many reset requests (3 per hour)

  /auth/reset-password:
    post:
      summary: Reset password with token
      description: Update password using reset token from email
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, token, newPassword]
              properties:
                email:
                  type: string
                  format: email
                token:
                  type: string
                newPassword:
                  type: string
                  minLength: 8
      responses:
        '200':
          description: Password reset successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password reset successfully

  /auth/resend-verification:
    post:
      summary: Resend verification email
      description: Send new verification email to user
      tags: [Authentication]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email]
              properties:
                email:
                  type: string
                  format: email
      responses:
        '200':
          description: Verification email sent
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Verification email sent

  # =====================================================
  # CHAT ENDPOINTS
  # =====================================================
  /chat/chat:
    post:
      summary: Send message and get AI response
      description: Send a message to AI and receive response with token tracking
      tags: [Chat]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                conversationId:
                  type: string
                  format: uuid
                  description: Existing conversation ID (optional for new chat)
                content:
                  type: string
                  minLength: 1
                  maxLength: 10000
                  example: "Explain quantum computing in simple terms"
                model:
                  type: string
                  enum: [gpt-4, gpt-4o, gpt-3.5-turbo, claude-3-opus, claude-3-sonnet]
                  default: gpt-4
                  description: AI model to use
      responses:
        '200':
          description: Message sent and AI responded
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      messageId:
                        type: string
                        format: uuid
                      conversationId:
                        type: string
                        format: uuid
                      content:
                        type: string
                        example: "Quantum computing uses quantum bits..."
                      tokenCount:
                        type: integer
                        example: 250
                      model:
                        type: string
                      createdAt:
                        type: string
                        format: date-time
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '402':
          description: Quota exceeded or billing error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /chat/conversations:
    get:
      summary: Get user conversations
      description: List all conversations for authenticated user with pagination
      tags: [Chat]
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            maximum: 100
          description: Number of results per page
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Pagination offset
      responses:
        '200':
          description: List of conversations
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Conversation'
                  total:
                    type: integer
                  limit:
                    type: integer
                  offset:
                    type: integer
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /chat/conversations/{id}:
    get:
      summary: Get conversation by ID
      description: Retrieve single conversation with all messages
      tags: [Chat]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Conversation details
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    allOf:
                      - $ref: '#/components/schemas/Conversation'
                      - type: object
                        properties:
                          messages:
                            type: array
                            items:
                              $ref: '#/components/schemas/Message'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Conversation not found

    delete:
      summary: Delete conversation
      description: Delete conversation and all associated messages
      tags: [Chat]
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Conversation deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Conversation deleted successfully
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: Conversation not found

  /chat/usage:
    get:
      summary: Get token usage statistics
      description: Get current month's token usage and quota information
      tags: [Chat]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Usage statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      monthlyQuota:
                        type: integer
                        example: 100000
                      monthlyUsed:
                        type: integer
                        example: 45230
                      remaining:
                        type: integer
                        example: 54770
                      percentageUsed:
                        type: number
                        format: float
                        example: 45.23
                      resetDate:
                        type: string
                        format: date
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  # =====================================================
  # BILLING ENDPOINTS
  # =====================================================
  /billing/subscribe:
    post:
      summary: Create subscription
      description: Subscribe user to a paid plan
      tags: [Billing]
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [planTier, paymentMethodId]
              properties:
                planTier:
                  type: string
                  enum: [PLUS, PRO]
                  example: PRO
                paymentMethodId:
                  type: string
                  description: Stripe payment method ID
      responses:
        '200':
          description: Subscription created
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Subscription'
        '400':
          description: Invalid plan or payment method
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '402':
          description: Payment failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /billing/cancel:
    post:
      summary: Cancel subscription
      description: Cancel active subscription immediately
      tags: [Billing]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Subscription cancelled
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Subscription cancelled successfully
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '404':
          description: No active subscription found

  /billing/subscription:
    get:
      summary: Get subscription info
      description: Retrieve current subscription details
      tags: [Billing]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Subscription details
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Subscription'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /billing/usage:
    get:
      summary: Get usage statistics
      description: Get current usage and quota information
      tags: [Billing]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Usage data
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/UsageResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /billing/payments:
    get:
      summary: Get payment history
      description: List all payments for authenticated user
      tags: [Billing]
      security:
        - BearerAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Payment history
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Payment'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /billing/plans:
    get:
      summary: Get pricing plans
      description: List all available subscription plans
      tags: [Billing]
      responses:
        '200':
          description: Available plans
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Plan'

  # =====================================================
  # ANALYTICS ENDPOINTS (Admin/Read-only)
  # =====================================================
  /analytics/users/count:
    get:
      summary: Get total user count by plan tier
      description: Retrieve user statistics grouped by subscription plan
      tags: [Analytics]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User count by plan
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      free:
                        type: integer
                      plus:
                        type: integer
                      pro:
                        type: integer
                      total:
                        type: integer
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /analytics/users/growth:
    get:
      summary: Get user growth over time
      description: Retrieve user growth metrics for specified date range
      tags: [Analytics]
      security:
        - BearerAuth: []
      parameters:
        - name: startDate
          in: query
          schema:
            type: string
            format: date
          required: false
          description: Start date (YYYY-MM-DD)
        - name: endDate
          in: query
          schema:
            type: string
            format: date
          required: false
          description: End date (YYYY-MM-DD)
      responses:
        '200':
          description: User growth data
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        date:
                          type: string
                          format: date
                        newUsers:
                          type: integer
                        totalUsers:
                          type: integer

  /analytics/users/active:
    get:
      summary: Get active users (DAU/WAU/MAU)
      description: Retrieve daily, weekly, or monthly active users
      tags: [Analytics]
      security:
        - BearerAuth: []
      parameters:
        - name: period
          in: query
          schema:
            type: string
            enum: [day, week, month]
            default: day
      responses:
        '200':
          description: Active user count
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      period:
                        type: string
                      activeUsers:
                        type: integer
                      percentageOfTotal:
                        type: number

  /analytics/chat/messages:
    get:
      summary: Get total message count
      description: Retrieve total number of chat messages across platform
      tags: [Analytics]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Message count
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      totalMessages:
                        type: integer
                      totalConversations:
                        type: integer
                      avgMessagesPerConversation:
                        type: number

  /analytics/chat/by-provider:
    get:
      summary: Get messages by AI provider
      description: Retrieve message statistics grouped by AI provider
      tags: [Analytics]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Messages by provider
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        provider:
                          type: string
                        messageCount:
                          type: integer
                        percentageOfTotal:
                          type: number

  /analytics/revenue/total:
    get:
      summary: Get total revenue
      description: Retrieve total platform revenue
      tags: [Analytics]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Revenue data
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      totalRevenue:
                        type: number
                        format: currency
                      currency:
                        type: string
                        example: USD

  /analytics/revenue/mrr:
    get:
      summary: Get Monthly Recurring Revenue (MRR)
      description: Retrieve current MRR and trend
      tags: [Analytics]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: MRR data
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      mrr:
                        type: number
                        format: currency
                      previousMrr:
                        type: number
                      growth:
                        type: number
                        description: Growth percentage
                      currency:
                        type: string

  /analytics/providers/usage:
    get:
      summary: Get provider usage statistics
      description: Retrieve overall statistics for all AI providers
      tags: [Analytics]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Provider usage statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        provider:
                          type: string
                        tokensUsed:
                          type: integer
                        costUsd:
                          type: number
                        percentage:
                          type: number

  /analytics/providers/performance:
    get:
      summary: Get provider performance comparison
      description: Compare response times and quality metrics across providers
      tags: [Analytics]
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Performance metrics
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        provider:
                          type: string
                        avgResponseTime:
                          type: number
                          description: Average response time in ms
                        uptime:
                          type: number
                          description: Uptime percentage
                        costPerToken:
                          type: number

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /auth/signin endpoint

  schemas:
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        createdAt:
          type: string
          format: date-time
        emailVerified:
          type: boolean
        planTier:
          type: string
          enum: [FREE, PLUS, PRO]
        monthlyTokenUsed:
          type: integer
        isActive:
          type: boolean

    Message:
      type: object
      properties:
        id:
          type: string
          format: uuid
        conversationId:
          type: string
          format: uuid
        role:
          type: string
          enum: [user, assistant]
        content:
          type: string
        tokenCount:
          type: integer
        model:
          type: string
        createdAt:
          type: string
          format: date-time

    Conversation:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        title:
          type: string
        model:
          type: string
        messageCount:
          type: integer
        tokenCount:
          type: integer
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Subscription:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        stripeSubscriptionId:
          type: string
        status:
          type: string
          enum: [active, canceled, past_due, unpaid]
        planTier:
          type: string
          enum: [PLUS, PRO]
        currentPeriodStart:
          type: string
          format: date-time
        currentPeriodEnd:
          type: string
          format: date-time
        monthlyTokenQuota:
          type: integer
        createdAt:
          type: string
          format: date-time

    Payment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        subscriptionId:
          type: string
          format: uuid
        stripePaymentId:
          type: string
        amount:
          type: number
          format: currency
        currency:
          type: string
          example: USD
        status:
          type: string
          enum: [succeeded, failed, pending]
        createdAt:
          type: string
          format: date-time

    Plan:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
          enum: [Free, Plus, Pro]
        price:
          type: number
          format: currency
        interval:
          type: string
          enum: [month, year]
        monthlyTokenQuota:
          type: integer
        features:
          type: array
          items:
            type: string

    UsageResponse:
      type: object
      properties:
        monthlyQuota:
          type: integer
        monthlyUsed:
          type: integer
        remaining:
          type: integer
        percentageUsed:
          type: number
        resetDate:
          type: string
          format: date

    Error:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              example: VALIDATION_ERROR
            message:
              type: string
            details:
              type: object

  responses:
    ValidationError:
      description: Validation error in request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error:
              code: VALIDATION_ERROR
              message: Validation failed
              details:
                email: Invalid email format

    UnauthorizedError:
      description: Authentication required or invalid token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error:
              code: UNAUTHORIZED
              message: Authentication required

    RateLimitError:
      description: Rate limit exceeded
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error:
              code: RATE_LIMIT_EXCEEDED
              message: Too many requests. Please try again later
