#!/bin/bash

# Pre-push hook ƒë·ªÉ check memory files before pushing
# Install: Copy file n√†y v√†o .git/hooks/pre-push v√† chmod +x

echo ""
echo "üîç Pre-push check: Verifying memory files are up-to-date..."

# Check n·∫øu c√≥ uncommitted changes trong memory files
if git diff --name-only | grep -qE "CLAUDE\.md|\.claude/.*\.md"; then
    echo ""
    echo "‚ö†Ô∏è  WARNING: You have uncommitted changes in memory files!" -ForegroundColor Yellow
    echo "   Files:"
    git diff --name-only | grep -E "CLAUDE\.md|\.claude/.*\.md" | sed 's/^/   - /'
    echo ""
    echo "   Consider committing these changes before pushing."
    echo ""
    read -p "   Continue push anyway? (y/n) " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "‚ùå Push cancelled. Commit your memory files first."
        exit 1
    fi
fi

# Check if CODEBASE_INDEX.md is outdated
INDEX_LAST_MODIFIED=$(git log -1 --format="%at" -- .claude/CODEBASE_INDEX.md 2>/dev/null || echo 0)
SRC_LAST_MODIFIED=$(git log -1 --format="%at" -- "backend/services/*/src/**/*.(ts|js)" 2>/dev/null || echo 0)

if [ "$SRC_LAST_MODIFIED" -gt "$INDEX_LAST_MODIFIED" ]; then
    echo ""
    echo "‚ö†Ô∏è  WARNING: CODEBASE_INDEX.md might be outdated!"
    echo "   Source files modified after index was last updated."
    echo ""
    echo "   Run: node .claude/regenerate-index.js"
    echo ""
    read -p "   Continue push anyway? (y/n) " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "‚ùå Push cancelled. Update index first."
        exit 1
    fi
fi

echo "‚úÖ Memory files check passed"
echo ""

exit 0
