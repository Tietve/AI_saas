generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String                   @id @default(cuid())
  email              String
  emailLower         String                   @unique
  passwordHash       String
  emailVerifiedAt    DateTime?
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  monthlyTokenUsed   Int                      @default(0)
  planTier           PlanTier                 @default(FREE)
  conversations      Conversation[]
  projects           Project[]
  verificationTokens EmailVerificationToken[]
  resetTokens        PasswordResetToken[]
  subscriptions      Subscription[]
  tokenUsages        TokenUsage[]
  settings           UserSetting?
  payments           Payment[]
  usageRecords       DailyUsageRecord[]
  invoices           Invoice[]
  feedbacks          MessageFeedback[]

  // Performance indexes
  @@index([planTier])
  @@index([monthlyTokenUsed])
  @@index([createdAt])
  @@index([planTier, monthlyTokenUsed])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  createdAt DateTime  @default(now())
  usedAt    DateTime?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Project {
  id            String         @id @default(cuid())
  userId        String
  name          String         @db.VarChar(100)
  description   String?        @db.VarChar(500)
  color         String?        @db.VarChar(20)
  icon          String?        @db.VarChar(50)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations Conversation[]

  @@index([userId, updatedAt(sort: Desc)])
}

model Conversation {
  id           String            @id @default(cuid())
  userId       String
  projectId    String?
  title        String?           @db.VarChar(200)
  systemPrompt String?
  meta         Json?
  botId        String?
  pinned       Boolean           @default(false)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  model        String            @default("gpt-4o-mini")
  attachments  Attachment[]
  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  project      Project?          @relation(fields: [projectId], references: [id], onDelete: SetNull)
  messages     Message[]
  feedbacks    MessageFeedback[]

  // Performance indexes
  @@index([userId, updatedAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, pinned, updatedAt(sort: Desc)])
  @@index([projectId, updatedAt(sort: Desc)])
  @@index([model])
  @@index([botId])
}

model Message {
  id               String            @id @default(cuid())
  conversationId   String
  role             Role
  content          String
  model            String?           @db.VarChar(100)
  promptTokens     Int?
  completionTokens Int?
  latencyMs        Int?
  idempotencyKey   String?
  createdAt        DateTime          @default(now())
  attachments      Attachment[]
  conversation     Conversation      @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  feedbacks        MessageFeedback[]

  @@unique([conversationId, idempotencyKey])
  @@index([conversationId, createdAt], map: "Message_conversationId_createdAt_asc_idx")
  @@index([conversationId, createdAt(sort: Desc)], map: "Message_conversationId_createdAt_desc_idx")
  @@index([role, conversationId])
  @@index([model])
  @@index([createdAt])
}

model MessageFeedback {
  id             String        @id @default(cuid())
  messageId      String
  userId         String
  conversationId String?
  feedback       String        // 'like' or 'dislike'
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  message        Message       @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation   Conversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([userId])
  @@index([conversationId])
}

model Attachment {
  id             String       @id @default(cuid())
  conversationId String
  messageId      String
  kind           String       @db.VarChar(50)
  url            String
  meta           Json?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  message        Message      @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([conversationId])
}

model Subscription {
  id                  String             @id @default(cuid())
  userId              String
  planTier            PlanTier
  status              SubscriptionStatus @default(ACTIVE)
  currentPeriodStart  DateTime
  currentPeriodEnd    DateTime
  cancelAtPeriodEnd   Boolean            @default(false)
  canceledAt          DateTime?
  payosSubscriptionId String?            @unique
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments            Payment[]

  @@index([userId, status])
  @@index([currentPeriodEnd])
}

model Payment {
  id               String        @id @default(cuid())
  userId           String
  subscriptionId   String?
  amount           Int
  currency         String        @default("VND")
  status           PaymentStatus @default(PENDING)
  payosOrderCode   Int?          @unique
  payosPaymentId   String?       @unique
  payosCheckoutUrl String?
  description      String?
  metadata         Json?
  paidAt           DateTime?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription     Subscription? @relation(fields: [subscriptionId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([payosOrderCode])
}

model DailyUsageRecord {
  id           String   @id @default(cuid())
  userId       String
  date         DateTime @db.Date
  messageCount Int      @default(0)
  modelUsed    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId, date])
}

model WebhookEvent {
  id           String             @id @default(cuid())
  externalId   String             @unique
  eventType    String
  source       String             @default("payos")
  status       WebhookEventStatus @default(PENDING)
  attempts     Int                @default(0)
  processedAt  DateTime?
  errorMessage String?
  rawPayload   Json
  createdAt    DateTime           @default(now())

  @@index([externalId])
  @@index([status])
}

model Invoice {
  id            String        @id @default(cuid())
  userId        String
  invoiceNumber String        @unique
  amount        Int
  currency      String        @default("VND")
  status        InvoiceStatus @default(PENDING)
  issuedDate    DateTime      @default(now())
  paidDate      DateTime?
  dueDate       DateTime?
  metadata      Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([invoiceNumber])
}

model TokenUsage {
  id        String   @id @default(cuid())
  userId    String
  tokensIn  Int
  tokensOut Int
  costUsd   Float    @default(0)
  meta      Json?
  createdAt DateTime @default(now())
  model     ModelId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Performance indexes
  @@index([userId, createdAt], map: "TokenUsage_userId_createdAt_asc_idx")
  @@index([userId, createdAt(sort: Desc)], map: "TokenUsage_userId_createdAt_desc_idx")
  @@index([userId, model])
  @@index([model, createdAt])
  @@index([createdAt(sort: Desc)])
}

model UserSetting {
  userId       String  @id
  theme        String?
  layoutConfig Json?
  defaultModel String?
  user         User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Enums
enum Role {
  USER
  ASSISTANT
  SYSTEM
}

enum PlanTier {
  FREE
  PLUS
  PRO
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAST_DUE
  PAUSED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELLED
  REFUNDED
}

enum WebhookEventStatus {
  PENDING
  PROCESSED
  FAILED
  SKIPPED
}

enum InvoiceStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum ModelId {
  gpt_4_turbo
  gpt_4o
  gpt_4o_mini
  gpt_4_1_nano
  gpt_3_5_turbo
  gpt_5
  gpt_5_mini
  gpt_5_nano
  claude_3_opus
  claude_3_5_sonnet
  claude_3_5_haiku
  gemini_1_5_pro
  gemini_1_5_flash
  gemini_2_0_flash
}
