# Scout Summary: Chat-Service Structure Analysis

## Report Generated
- **File:** `scout/scout-01-chat-service-structure.md`
- **Date:** 2025-11-13
- **Thoroughness:** Medium
- **Status:** Complete

## Executive Summary

Scouted chat-service codebase (Port 3003) to identify architectural patterns and integration points for PDF Q&A implementation.

**Key Finding:** Chat-service is well-structured with reusable patterns for document processing:
- Controller → Service → Repository layering
- OpenAI integration (token estimation, streaming)
- Billing quota integration
- Event publishing to analytics (RabbitMQ)
- Database persistence (Prisma + PostgreSQL)

## What to Reuse

| Component | Location | Benefit |
|-----------|----------|---------|
| JWT Auth Middleware | `src/middleware/auth.ts` | Drop-in protection for document endpoints |
| OpenAI Client | `src/services/openai.service.ts` | RAG queries + token estimation |
| Billing Client | `src/services/billing-client.service.ts` | Quota validation for uploads/queries |
| Event Publisher | `src/shared/events/` | Track document usage analytics |
| SSE Streaming | `controllers/chat.controller.ts` | Stream RAG results real-time |
| Repository Pattern | `repositories/` | Document CRUD operations |
| Prisma Config | `config/database.ts` | Connection pooling + retries |
| Error Handling | `controllers/chat.controller.ts` | Status codes (400/401/429/500) |

## What to Build

1. **New Controllers:** `document.controller.ts` (upload, query, delete, list)
2. **New Services:** 
   - `document.service.ts` - PDF processing, chunking
   - `embedding.service.ts` - Vector embeddings (Pinecone/pgvector)
3. **New Repositories:** 
   - `document.repository.ts` - Document CRUD
   - `document-chunk.repository.ts` - Chunk storage
4. **New Routes:** `document.routes.ts` - 4 endpoints
5. **Update Prisma:** Add `Document` and `DocumentChunk` models
6. **Update Config:** `env.ts` - PDF size limit, vector DB URL

## Database Extensions

Add 2 new models to `prisma/schema.prisma`:
- `Document` - metadata (title, fileSize, status, userId)
- `DocumentChunk` - text chunks with embeddings (documentId, content, embedding, tokens)

## Integration Points

- **JWT:** All document routes protected by `authenticateToken` middleware
- **OpenAI:** Reuse client for RAG queries with token counting
- **Billing:** Check quota before upload/query (429 response if exceeded)
- **Events:** Publish `document.uploaded`, `document.queried` events
- **Streaming:** Use SSE pattern for chunked RAG results

## New Dependencies Required

- `pdf-parse` or `pdfjs-dist` - PDF extraction
- `@pinecone-database/pinecone` or `pg-vector` - Vector storage
- `multer` - File upload middleware (optional, can use fetch/multipart)

## Files to Create vs Update

**Create (5):**
- `src/controllers/document.controller.ts`
- `src/services/document.service.ts`
- `src/services/embedding.service.ts`
- `src/repositories/document.repository.ts`
- `src/routes/document.routes.ts`

**Update (3):**
- `prisma/schema.prisma` - Add 2 models
- `src/config/env.ts` - Add PDF config vars
- `src/app.ts` - Register document routes

**Reuse (3):**
- `src/middleware/auth.ts`
- `src/services/openai.service.ts`
- `src/services/billing-client.service.ts`

## Next Steps

1. Review scout report: `scout/scout-01-chat-service-structure.md`
2. Create implementation plan for PDF processing pipeline
3. Design database schema for documents and chunks
4. Implement document.service.ts with chunking logic
5. Integrate vector embedding service
6. Add file upload endpoint
7. Implement RAG query endpoint

## Estimate

- **Lines of Code:** ~800-1000 (new services + repositories)
- **New Files:** 5
- **Updated Files:** 3
- **Dependencies:** 3-4 new packages
- **Complexity:** Medium (reusing patterns, no architectural changes)

---

**Generated by:** Scout Agent (Chat-Service Analysis)  
**Confidence:** High - Direct code inspection of 10+ key files
