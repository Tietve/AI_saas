<!DOCTYPE html>
<html>
<head>
    <title>Test Upload Flow</title>
</head>
<body>
    <h1>Test Upload & Text Extraction Flow</h1>

    <input type="file" id="fileInput" />
    <button onclick="testUpload()">Upload & Test</button>

    <pre id="output"></pre>

    <script>
        async function testUpload() {
            const output = document.getElementById('output');
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];

            if (!file) {
                output.textContent = 'Please select a file first';
                return;
            }

            output.textContent = 'Uploading...\n';

            // Step 1: Upload
            const formData = new FormData();
            formData.append('files', file);

            try {
                const uploadRes = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                const uploadData = await uploadRes.json();
                output.textContent += 'Upload Response:\n' + JSON.stringify(uploadData, null, 2) + '\n\n';

                const attachment = uploadData.attachments[0];
                output.textContent += 'Has extractedText: ' + ('extractedText' in (attachment.meta || {})) + '\n';

                if (attachment.meta?.extractedText) {
                    output.textContent += 'ExtractedText length: ' + attachment.meta.extractedText.length + '\n';
                    output.textContent += 'ExtractedText preview: ' + attachment.meta.extractedText.substring(0, 100) + '\n\n';
                }

                // Step 2: Test sending to test-attachment endpoint
                output.textContent += 'Testing chat payload...\n';

                const testRes = await fetch('/api/test-attachment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        attachments: [attachment]
                    })
                });

                const testData = await testRes.json();
                output.textContent += 'Test Response:\n' + JSON.stringify(testData.debug, null, 2) + '\n';

            } catch (error) {
                output.textContent += 'Error: ' + error.message;
            }
        }
    </script>
</body>
</html>
